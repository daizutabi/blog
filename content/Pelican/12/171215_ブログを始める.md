Title: ブログを始める
Date: 2017-12-15
Category: Pelican

[GitHub Pages](https://pages.github.com/)でブログを始めることにしました．静的サイトジェネレータには[Pelican](https://blog.getpelican.com/)を用います．フォーマットはマークダウンにします．Pelicanでは，各記事のファイルの先頭に以下のようなメタデータを書く必要があります．

```text
Title: My First Review
Date: 2010-12-03 10:20
Category: Review
Slug: URL
```

記事を書くたびにこれらのメタデータを入力するのは少々面倒なので自動化を試みます．その成果をプロジェクト[`takuhai`](https://github.com/daizutabi/takuhai)にまとめたいと思っています．自動化のために定めた規約を紹介しておきます：

+ 記事を格納するルートディレクトリ（デフォルトでは`content`）直下のディレクトリ名をカテゴリー名とする．
+ その下のディレクトリから各記事に至るまでのディレクトリ構造は任意である．
+ 記事のファイル名は`<YYMMDD><sep><title>.md`とする．
+ `<YYMMDD>`は年月日である．例えば2017年12月6日であれば`171206`とする．西暦は下2桁のみを用いる．
+ `<sep>`は任意の1文字である．ファイル名が読みやすくなるように選べばよい．典型的にはアンダースコア(`_`)やピリオド(`.`)が選ばれる．
+ `<title>`はタイトルにそのまま用いる．
+ ファイルの先頭から`:`を含まない行か空行までをメタデータとする．
+ メタデータがひとつも含まれないファイルは，最初の行を空行とする．

それでは，`content`ディレクトリの下に`Pelican/12/171215_ブログを始める.md`を作成しましょう．ファイル名の途中の`/12/`は12月だからです．以下の内容で保存しておきます（最初の空行は必要です）:

```text
(ここには空行が入ります)
[GitHub Pages](https://pages.github.com/)でブログを始めることにしました．（後略）
```

`convert`関数を呼ぶと，このファイルに自動でメタデータを追加してくれます．

```python
>>> convert('Pelican/12/171215_ブログを始める.md')
```

`Pelican/12/171215_ブログを始める.md`は，以下の内容に変換されます．


```text
Title: ブログを始める
Date: 2017-12-15
Category: Pelican

[GitHub Pages](https://pages.github.com/)でブログを始めることにしました．（後略）
```

以上のような規約を用いた理由を述べておきましょう．まずルートディレクトリ直下にカテゴリを置いたのは，同じカテゴリ間で記事を参照することが多いためです．あるカテゴリーに属する記事は，そのディレクトリ下にあることが保証されるため，記事を検索することが容易となります．

規約では，ルートディレクトリから記事のファイルに至るまでのディレクトリ構造を無視するようにしました．これは，流動的なディレクトリ構造を可能にするためです．ひとつめの記事を書くのに，わざわざ`2017/12/06`といったディレクトリ構造を作るのは大げさでしょう．はじめのうちは，カテゴリーディレクトリの直下に`171206_something.md`を作っておけばよいのです．記事が多くなってディレクトリ内の見通しが悪くなったら，月ごとあるいは年ごとのディレクトリを作ってそこに記事を移動します．どのようなディレクトリ構造の中にあっても，ファイル名で記事の日付，タイトルを指定できます．


最後に`convert`関数の実装を紹介して，この記事を終えます．

```python
import codecs
import os
from collections import OrderedDict


def convert(path, root='.'):
    """
    pathの文字列からメタデータを抽出して，pathのファイルに
    メタデータを書き込む．

    pathは<YYMMDD><sep><title>.<ext>の形式である必要がある．

    Parameters
    ----------
    path : str
        ファイル名
    root : str, optional
        ルートディレクトリ名．省略するとカレントディレクトリとする．
    """
    category = None
    directory, basename = os.path.split(path)
    while directory:
        directory, category = os.path.split(directory)

    basename = os.path.splitext(basename)[0]
    date, title = basename[:6], basename[7:]
    date = '-'.join(['20' + date[0:2], date[2:4], date[4:6]])

    metadata = OrderedDict()
    metadata['Title'] = title
    metadata['Date'] = date
    if category:
        metadata['Category'] = category
    metadata['Slug'] = title

    abspath = os.path.join(root, path)
    with codecs.open(abspath, 'r', 'utf-8') as file:
        lines = file.readlines()

    def header(key, sep):
        return ': '.join([key, metadata.pop(key)]) + sep

    # 最初の空行か':'を含まない行までをメタデータとする．
    for index, line in enumerate(lines):
        sep = '\r\n' if line.endswith('\r\n') else '\n'
        if line.strip() == '' or ':' not in line:
            # 残っているメタデータを書き込む．
            for key in list(metadata.keys()):  # popするため
                lines.insert(index, header(key, sep))
                index += 1
            break
        key, *_ = line.split(':')
        key = key.strip()
        if key in metadata:
            lines[index] = header(key, sep)

    text = ''.join(lines)

    with codecs.open(abspath, 'w', 'utf-8') as file:
        file.write(text)


def main():
    root = 'C:/Users/daizu/Documents/GitHub/blog/content'
    path = 'Pelican/12/171215_ブログを始める.md'
    convert(path, root)


if __name__ == '__main__':
    main()
```
