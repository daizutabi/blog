Title: ブログを始める
Date: 2017-12-15
Category: Pelican
Slug: ブログを始める

[GitHub Pages](https://pages.github.com/)でブログを始めることにした．静的サイトジェネレータには[Pelican](https://blog.getpelican.com/)を用いる．記事はマークダウンで書くことにする．以下のようなメタデータを記事の先頭に書くことによってナビゲーションが機能する．

```text
Title: My First Review
Date: 2010-12-03 10:20
Category: Review
Slug: URL
```

記事を書くたびにこれらのメタデータを入力するのは面倒であるので自動化する．そのために以下の規約を定める：

+ 記事を格納するルートディレクトリ（デフォルトでは`content`）直下のディレクトリ名をカテゴリー名とする．
+ その下のディレクトリから各記事に至るまでのディレクトリ構造は任意である．
+ 記事のファイル名は`<YYMMDD><sep><title>.md`とする．
+ `<YYMMDD>`は年月日である．例えば2017年12月6日であれば`171206`とする．2100年まで生きる心配はないので，西暦は下2桁のみを用いる．
+ `<sep>`は任意の1文字である．ファイル名を読みやすいように選べばよい．典型的にはアンダースコア(`_`)やピリオド(`.`)が選ばれる．
+ `<title>`はタイトルおよびスラグの両方の値にそのまま用いる．
+ ファイルの内容の先頭が`Title:`でない場合は，メタデータが生成されていないものとみなす．
+ メタデータが生成されている場合は，ファイルの先頭から最初の空行の前までをメタデータとする．

それでは，`content`ディレクトリの下に`Pelican/12/171215_ブログを始める.md`を作成する．ファイル名の途中の`/12/`は12月だからである．以下の内容で保存しておく：

```text
[GitHub Pages](https://pages.github.com/)でブログを始めることにした．（後略）
```

`convert`関数を呼ぶと，このファイルに自動でメタデータを追加する．

```python
>>> convert('Pelican/12/171215_ブログを始める.md')
```

`Pelican/12/171215_ブログを始める.md`は，以下の内容に変換される．


```text
Title: ブログを始める
Date: 2017-12-15
Category: Pelican
Slug: ブログを始める

[GitHub Pages](https://pages.github.com/)でブログを始めることにした．（後略）
```

以上のような規約を用いた理由を述べておく．まずルートディレクトリ直下にカテゴリを置いたのは，同じカテゴリ間で記事を参照することが多いためである．あるカテゴリーに属する記事は，そのディレクトリ下にあることが保証されるため，議事を検索することが容易となる．

ルートディレクトリから記事のファイルに至るまでのディレクトリ構造を無視するようにしたのは，ディレクトリ構造が流動的であるためである．一つの記事を書くのに，わざわざ`2017/12/06`といったディレクトリ構造を作るのは無意味である．そもそも2018年にも同じサイトで記事を書いている保証はない．最初は，カテゴリーのディレクトリ直下に`20171206_something.md`を作ればよい．記事がたまってきたら，月ごとあるいは年ごとのディレクトリを作ってそこに記事を移動する．どのようなディレクトリ以下にあっても，ファイル名で記事の日付とタイトルを指定できる．


最後に`convert`関数の実装を紹介して，この記事を終える．

```python
import codecs
import os


def convert(path, root='.'):
    """
    pathの文字列からメタデータを抽出して，pathの内容に
    メタデータを書き込む．

    pathは<YYMMDD><sep><title>.<ext>の形式である必要がある．

    Parameters
    ----------
    path : str
        ファイル名
    root : str, optional
        ディレクトリ名．省略するとカレントディレクトリとする．
    """
    directory, basename = os.path.split(path)
    while directory:
        directory, category = os.path.split(directory)

    basename = os.path.splitext(basename)[0]
    date, title = basename[:6], basename[7:]
    date = '-'.join(['20' + date[0:2], date[2:4], date[4:6]])

    metadata = [
        f'Title: {title}', f'Date: {date}',
        f'Category: {category}', f'Slug: {title}', '']

    abspath = os.path.join(root, path)
    with codecs.open(abspath, 'r', 'utf-8') as file:
        lines = file.readlines()
    lines = [line.strip() for line in lines]

    # すでにメタデータがある場合にはそれを削除する．
    if lines[0].startswith('Title:'):
        lines = lines[lines.index('') + 1:]

    text = '\n'.join(metadata + lines)
    with codecs.open(abspath, 'w', 'utf-8') as file:
        file.write(text)
```
